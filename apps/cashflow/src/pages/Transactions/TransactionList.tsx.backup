import React, { useState, useEffect, useCallback } from "react";
import { useTranslation } from "react-i18next";
import { useNavigate, useSearchParams } from "react-router-dom";
import { databaseService } from "../../services/database";
import type { Transaction, Customer } from "../../types";
import {
  formatCurrency,
  formatDate,
  getTransactionTypeColor,
  getTransactionTypeTextColor,
} from "../../utils/formatting";
import { LoadingFallback, ErrorFallback } from "../../components/UI/FallbackUI";
import Pagination from "../../components/UI/Pagination";
import TimeRangeFilter from "../../components/UI/TimeRangeFilter";
import Button from "../../components/UI/Button";
import PageHeader from "../../components/UI/PageHeader";

interface TransactionListState {
  transactions: Transaction[];
  loading: boolean;
  error: string | null;
  totalCount: number;
  currentPage: number;
  pageSize: number;
  searchTerm: string;
  dateRange: {
    start: string;
    end: string;
  } | null;
  transactionType: string | null;
  customerFilter: {
    id: string | null;
    name: string | null;
  } | null;
}

const TransactionList: React.FC = () => {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [bankAccounts, setBankAccounts] = useState<any[]>([]);
  const defaultBranchMap: Record<string, string> = {
    "1": "Văn phòng chính",
    "2": "Văn phòng Bắc",
    "3": "Văn phòng Nam",
  };
  const [branchMap, setBranchMap] = useState<Record<string, string>>(defaultBranchMap);
  const [formData, setFormData] = useState({
    customer_id: "",
    bank_account_id: "",
    transaction_type: "payment",
    amount: "",
    description: "",
    reference_number: "",
    transaction_date: new Date().toISOString().slice(0, 10),
  });
  const [state, setState] = useState<TransactionListState>({
    transactions: [],
    loading: true,
    error: null,
    totalCount: 0,
    currentPage: 1,
    pageSize: 20,
    searchTerm: "",
    dateRange: null,
    transactionType: null,
    customerFilter: null,
  });

  // Initialize customer filter from URL params
  useEffect(() => {
    const customerId = searchParams.get("customer_id");
    const customerName = searchParams.get("customer_name");

    if (customerId && customerName) {
      setState((prev) => ({
        ...prev,
        customerFilter: {
          id: customerId,
          name: customerName,
        },
      }));
    }
  }, [searchParams]);

  // Fetch transactions
  const fetchTransactions = useCallback(async () => {

    setState((prev) => ({ ...prev, loading: true, error: null }));

    try {
      const filters = {
        search: state.searchTerm || undefined,
        dateRange: state.dateRange || undefined,
        transaction_type: state.transactionType || undefined,
        customer_id: state.customerFilter?.id || undefined,
        page: state.currentPage,
        pageSize: state.pageSize,
      };

      const result =
        await databaseService.transactions.getTransactions(filters);

      if (result.error) {
        setState((prev) => ({ ...prev, error: result.error, loading: false }));
      } else if (result.data) {
        setState((prev) => ({
          ...prev,
          transactions: result.data,
          totalCount: result.count || 0,
          loading: false,
        }));
      }
    } catch (err) {
      setState((prev) => ({
        ...prev,
        error:
          err instanceof Error ? err.message : "Failed to load transactions",
        loading: false,
      }));
    }
  }, [
    state.searchTerm,
    state.dateRange,
    state.transactionType,
    state.customerFilter,
    state.currentPage,
    state.pageSize,
  ]);

  const loadFormOptions = useCallback(async () => {
    const [customerResult, bankResult] = await Promise.all([
      databaseService.customers.getCustomers(),
      databaseService.bankAccounts.getBankAccounts(),
    ]);
    if (customerResult.data) setCustomers(customerResult.data);
    if (bankResult.data) setBankAccounts(bankResult.data);
  }, []);

  useEffect(() => {
    if (!showCreateModal) return;
    loadFormOptions();
  }, [showCreateModal, loadFormOptions]);

  const resetForm = () => {
    setFormData({
      customer_id: "",
      bank_account_id: "",
      transaction_type: "payment",
      amount: "",
      description: "",
      reference_number: "",
      transaction_date: new Date().toISOString().slice(0, 10),
    });
  };

  const handleCreateTransaction = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.customer_id || !formData.bank_account_id || !formData.amount) return;
    setIsSaving(true);
    try {
      const amount = Number(formData.amount);
      const result = await databaseService.transactions.createTransaction({
        customer_id: formData.customer_id,
        bank_account_id: formData.bank_account_id,
        transaction_type: formData.transaction_type,
        amount: Number.isFinite(amount) ? amount : 0,
        description: formData.description,
        reference_number: formData.reference_number,
        transaction_date: formData.transaction_date
          ? new Date(formData.transaction_date).toISOString()
          : new Date().toISOString(),
      });
      if (!result.error) {
        setShowCreateModal(false);
        resetForm();
        fetchTransactions();
      }
    } finally {
      setIsSaving(false);
    }
  };

  // Load data on component mount and when filters change
  useEffect(() => {
    fetchTransactions();
  }, [fetchTransactions]);

  useEffect(() => {
    let isMounted = true;
    const loadBranches = async () => {
      const response = await databaseService.branches.getBranches();
      if (!response?.data || !isMounted) return;
      const map = response.data.reduce((acc: Record<string, string>, branch: any) => {
        const rawName = String(branch.name || branch.branch_name || branch.code || branch.id);
        const normalizedName = rawName.replace(/Chi nhánh/gi, "Văn phòng");
        acc[String(branch.id)] = normalizedName;
        return acc;
      }, {} as Record<string, string>);
      if (Object.keys(map).length > 0) {
        setBranchMap(map);
      }
    };
    loadBranches();
    return () => {
      isMounted = false;
    };
  }, []);

  // Handle search
  const handleSearch = (value: string) => {
    setState((prev) => ({ ...prev, searchTerm: value, currentPage: 1 }));
  };

  // Handle date range change
  const handleDateRangeChange = (start: string, end: string) => {
    setState((prev) => ({
      ...prev,
      dateRange: start && end ? { start, end } : null,
      currentPage: 1,
    }));
  };

  // Handle transaction type filter
  const handleTransactionTypeChange = (type: string | null) => {
    setState((prev) => ({
      ...prev,
      transactionType: type,
      currentPage: 1,
    }));
  };

  // Handle page change
  const handlePageChange = (page: number) => {
    setState((prev) => ({ ...prev, currentPage: page }));
  };

  // Get transaction type color
  const getTransactionTypeLabel = (type: string) => {
    switch (type) {
      case "payment":
        return "Thanh toán";
      case "charge":
        return "Cho nợ";
      case "adjustment":
        return "Điều chỉnh";
      case "refund":
        return "Hoàn tiền";
      default:
        return type;
    }
  };

  // Function to get branch name from branch_id
  const getBranchName = (branchId: string) => {
    return branchMap[String(branchId)] || defaultBranchMap[String(branchId)] || "Văn phòng không xác định";
  };

  if (state.loading) {
    return (
      <div className="min-h-screen bg-gray-50 py-8">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <LoadingFallback
            title={t("transactions.loading")}
            message={t("transactions.loadingData")}
            size="lg"
          />
        </div>
      </div>
    );
  }

  if (state.error) {
    return (
      <div className="min-h-screen bg-gray-50 py-8">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <ErrorFallback
            title={t("transactions.error")}
            message={state.error}
            retry={fetchTransactions}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <PageHeader
          title="Giao dịch"
          subtitle="Quản lý và theo dõi các giao dịch công nợ"
          actions={
            <Button
              variant="primary"
              size="md"
              onClick={() => setShowCreateModal(true)}
              className="inline-flex items-center"
            >
              <svg
                className="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                />
              </svg>
              Thêm giao dịch mới
            </Button>
          }
        />
        {state.customerFilter && (
          <div className="mb-4 flex items-center space-x-2">
            <span className="text-sm text-gray-500 dark:text-gray-400">Đang xem giao dịch của:</span>
            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
              {state.customerFilter.name}
            </span>
            <button
              onClick={() => {
                setState((prev) => ({ ...prev, customerFilter: null }));
                navigate("/transactions");
              }}
              className="text-sm text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
              title="Xóa lọc khách hàng"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        )}

        {/* Filters */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
          <div className="px-6 py-4 border-b border-gray-200 dark:border-gray-600">
            <h3 className="text-lg font-medium text-gray-900 dark:text-white">
              Bộ lọc giao dịch
            </h3>
          </div>
          <div className="px-6 py-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* Search */}
              <div>
                <label
                  htmlFor="search"
                  className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >
                  Tìm kiếm
                </label>
                <input
                  type="text"
                  id="search"
                  value={state.searchTerm}
                  onChange={(e) => handleSearch(e.target.value)}
                  placeholder="Tìm theo mã, khách hàng, mô tả..."
                  className="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                />
              </div>

              {/* Date Range */}
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Khoảng thời gian
                </label>
                <TimeRangeFilter
                  value={state.dateRange}
                  onChange={(range) => {
                    if (range) {
                      handleDateRangeChange(range.start, range.end);
                    } else {
                      handleDateRangeChange("", "");
                    }
                  }}
                  placeholder="Tất cả thời gian"
                />
              </div>

              {/* Transaction Type */}
              <div>
                <label
                  htmlFor="transactionType"
                  className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                >
                  Loại giao dịch
                </label>
                <select
                  id="transactionType"
                  value={state.transactionType || ""}
                  onChange={(e) =>
                    handleTransactionTypeChange(e.target.value || null)
                  }
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                >
                  <option value="">Tất cả loại</option>
                  <option value="payment">Thanh toán</option>
                  <option value="charge">Cho nợ</option>
                  <option value="adjustment">Điều chỉnh</option>
                  <option value="refund">Hoàn tiền</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        {/* Transactions Table */}
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
          <div className="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 dark:border-gray-600">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <h3 className="text-base sm:text-lg font-medium text-gray-900 dark:text-white">
                Danh sách giao dịch
              </h3>
              <div className="flex flex-col sm:flex-row sm:items-center gap-3">
                <div className="flex items-center space-x-2">
                  <span className="text-sm text-gray-500 dark:text-gray-400">Hiển thị</span>
                  <select
                    value={state.pageSize}
                    onChange={(e) =>
                      setState((prev) => ({
                        ...prev,
                        pageSize: Number(e.target.value),
                        currentPage: 1,
                      }))
                    }
                    className="border border-gray-300 dark:border-gray-600 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white min-w-[60px]"
                  >
                    <option value={5}>5</option>
                    <option value={10}>10</option>
                    <option value={15}>15</option>
                    <option value={20}>20</option>
                    <option value={30}>30</option>
                    <option value={50}>50</option>
                    <option value={100}>100</option>
                  </select>
                  <span className="text-sm text-gray-500 dark:text-gray-400">giao dịch</span>
                </div>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Hiển thị {(state.currentPage - 1) * state.pageSize + 1} đến{" "}
                  {Math.min(
                    state.currentPage * state.pageSize,
                    state.totalCount,
                  )}{" "}
                  trong tổng số {state.totalCount} giao dịch
                </p>
              </div>
            </div>
          </div>

          {state.transactions.length === 0 ? (
            <div className="px-4 sm:px-6 py-8 sm:py-12 text-center">
              <p className="text-gray-500 dark:text-gray-400">Không có giao dịch nào</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                <thead className="bg-gray-50 dark:bg-gray-700">
                  <tr>
                    <th className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Ngày giao dịch
                    </th>
                    <th className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Mã giao dịch
                    </th>
                    <th className="hidden sm:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Khách hàng
                    </th>
                    <th className="hidden lg:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Tài khoản ngân hàng
                    </th>
                    <th className="hidden md:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Văn phòng
                    </th>
                    <th className="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Loại giao dịch
                    </th>
                    <th className="px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Số tiền
                    </th>
                    <th className="hidden sm:table-cell px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Mô tả
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                  {state.transactions.map((transaction) => (
                    <tr key={transaction.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                        <div className="flex flex-col sm:flex-row sm:items-center gap-1">
                          <svg className="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4l4 4m0 0l4-4M4 7V3m0 4l4 4" />
                          </svg>
                          <span>{formatDate(transaction.transaction_date)}</span>
                        </div>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900 dark:text-white">
                        <span className="font-mono bg-gray-100 dark:bg-gray-700 px-1 sm:px-2 py-0.5 rounded text-xs sm:text-xs">
                          {transaction.transaction_code}
                        </span>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 dark:text-white hidden sm:table-cell">
                        <div className="flex flex-col">
                          <span className="font-medium truncate max-w-[120px]">{transaction.customer_name || `Customer #${transaction.customer_id}`}</span>
                          {transaction.customer_code && (
                            <span className="text-xs text-gray-500 dark:text-gray-400 font-mono">{transaction.customer_code}</span>
                          )}
                        </div>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 dark:text-white hidden lg:table-cell">
                        <span className="truncate max-w-[100px]">{transaction.bank_account_name || 'N/A'}</span>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900 dark:text-white hidden md:table-cell">
                        <span className="truncate max-w-[80px]">{transaction.branch_name || 'N/A'}</span>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                          transaction.transaction_type === 'payment'
                            ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
                            : transaction.transaction_type === 'charge'
                            ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                            : transaction.transaction_type === 'adjustment'
                            ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200'
                            : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'
                        }`}>
                          {transaction.transaction_type === 'payment' ? 'Thanh toán' :
                           transaction.transaction_type === 'charge' ? 'Cho nợ' :
                           transaction.transaction_type === 'adjustment' ? 'Điều chỉnh' :
                           transaction.transaction_type === 'refund' ? 'Hoàn tiền' : transaction.transaction_type}
                        </span>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-right">
                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-1">
                          <span className={`text-xs sm:text-sm font-bold ${
                            transaction.increase > 0
                              ? 'text-green-600 dark:text-green-400'
                              : transaction.decrease > 0
                              ? 'text-red-600 dark:text-red-400'
                              : 'text-gray-600 dark:text-gray-400'
                          }`}>
                            {formatCurrency(transaction.increase || transaction.decrease || 0)}
                          </span>
                        </div>
                      </td>
                      <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500 dark:text-gray-400 hidden sm:table-cell">
                        <span className="truncate max-w-[150px]">{transaction.description || '-'}</span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Pagination */}
          {state.totalCount > state.pageSize && (
            <div className="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 dark:border-gray-600">
              <Pagination
                currentPage={state.currentPage}
                totalPages={Math.ceil(state.totalCount / state.pageSize)}
                onPageChange={handlePageChange}
                totalItems={state.totalCount}
                itemsPerPage={state.pageSize}
              />
            </div>
          )}
        </div>

        {/* Create Transaction Modal */}
        {showCreateModal && (
          <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div className="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
              <div className="mt-3">
                <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-4">
                  Tạo giao dịch mới
                </h3>
                <form onSubmit={handleCreateTransaction}>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Khách hàng
                      </label>
                      <select
                        value={formData.customer_id}
                        onChange={(e) => setFormData(prev => ({ ...prev, customer_id: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        required
                      >
                        <option value="">Chọn khách hàng</option>
                        {customers.map((customer) => (
                          <option key={customer.id} value={customer.id}>
                            {customer.full_name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Tài khoản ngân hàng
                      </label>
                      <select
                        value={formData.bank_account_id}
                        onChange={(e) => setFormData(prev => ({ ...prev, bank_account_id: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        required
                      >
                        <option value="">Chọn tài khoản</option>
                        {bankAccounts.map((account) => (
                          <option key={account.id} value={account.id}>
                            {account.account_name} - {account.account_number}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Loại giao dịch
                      </label>
                      <select
                        value={formData.transaction_type}
                        onChange={(e) => setFormData(prev => ({ ...prev, transaction_type: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        required
                      >
                        <option value="payment">Thanh toán</option>
                        <option value="charge">Cho nợ</option>
                        <option value="adjustment">Điều chỉnh</option>
                        <option value="refund">Hoàn tiền</option>
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Số tiền
                      </label>
                      <input
                        type="number"
                        value={formData.amount}
                        onChange={(e) => setFormData(prev => ({ ...prev, amount: Number(e.target.value) }))}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        required
                        min="0"
                        step="0.01"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Mô tả
                      </label>
                      <textarea
                        value={formData.description}
                        onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        rows={3}
                      />
                    </div>
                  </div>

                  <div className="flex justify-end space-x-3 mt-6">
                    <button
                      type="button"
                      onClick={() => {
                        setShowCreateModal(false);
                        resetForm();
                      }}
                      className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                    >
                      Hủy
                    </button>
                    <button
                      type="submit"
                      disabled={isSaving}
                      className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {isSaving ? "Đang lưu..." : "Tạo giao dịch"}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default TransactionList;
                            ...prev,
                            customer_id: e.target.value,
                          }))
                        }
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                        required
                      >
                        <option value="">Chọn khách hàng</option>
                        {customers.map((customer) => (
                          <option key={customer.id} value={customer.id}>
                            {customer.full_name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700">
                        Tài khoản ngân hàng *
                      </label>
                      <select
                        value={formData.bank_account_id}
                        onChange={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            bank_account_id: e.target.value,
                          }))
                        }
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                        required
                      >
                        <option value="">Chọn tài khoản</option>
                        {bankAccounts.map((account) => (
                          <option key={account.id} value={account.id}>
                            {account.account_name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">
                          Loại giao dịch *
                        </label>
                        <select
                          value={formData.transaction_type}
                          onChange={(e) =>
                            setFormData((prev) => ({
                              ...prev,
                              transaction_type: e.target.value,
                            }))
                          }
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                        >
                          <option value="payment">Thanh toán</option>
                          <option value="charge">Cho nợ</option>
                          <option value="adjustment">Điều chỉnh</option>
                          <option value="refund">Hoàn tiền</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700">
                          Ngày giao dịch *
                        </label>
                        <input
                          type="date"
                          value={formData.transaction_date}
                          onChange={(e) =>
                            setFormData((prev) => ({
                              ...prev,
                              transaction_date: e.target.value,
                            }))
                          }
                          className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                          required
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700">
                        Số tiền *
                      </label>
                      <input
                        type="number"
                        min="0"
                        value={formData.amount}
                        onChange={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            amount: e.target.value,
                          }))
                        }
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700">
                        Mã tham chiếu
                      </label>
                      <input
                        type="text"
                        value={formData.reference_number}
                        onChange={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            reference_number: e.target.value,
                          }))
                        }
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700">
                        Mô tả
                      </label>
                      <textarea
                        rows={3}
                        value={formData.description}
                        onChange={(e) =>
                          setFormData((prev) => ({
                            ...prev,
                            description: e.target.value,
                          }))
                        }
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
                      />
                    </div>
                  </div>

                  <div className="flex justify-end mt-6">
                    <button
                      type="button"
                      onClick={() => {
                        setShowCreateModal(false);
                        resetForm();
                      }}
                      className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm"
                    >
                      Hủy
                    </button>
                    <button
                      type="submit"
                      disabled={isSaving}
                      className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-0 sm:w-auto sm:text-sm disabled:opacity-50"
                    >
                      {isSaving ? "Đang lưu..." : "Tạo giao dịch"}
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TransactionList;
